// Generated by CoffeeScript 1.4.0

/**
 * @package     CleverStyle Music
 * @category    Web Components
 * @author      Nazar Mokrynskyi <nazar@mokrynskyi.com>
 * @copyright   Copyright (c) 2014, Nazar Mokrynskyi
 * @license     MIT License, see license.txt
*/


(function() {
  var file_to_play, music_library, music_playlist, music_storage, player;

  music_storage = navigator.getDeviceStorage('music');

  music_library = cs.music_library;

  music_playlist = cs.music_playlist;

  player = null;

  file_to_play = null;

  Polymer('cs-music-player', {
    title: 'Unknown',
    artist: 'Unknown',
    ready: function() {},
    rescan: function() {
      return music_library.rescan(function() {
        music_playlist.refresh();
        return alert('Rescanned successfully, playlist refreshed');
      });
    },
    play: function(id) {
      var element, play_button,
        _this = this;
      id = !isNaN(parseInt(id)) ? id : void 0;
      element = this;
      play_button = element.shadowRoot.querySelector('[icon=play]');
      if (player && !id) {
        if (player.playing) {
          player.pause();
          return play_button.icon = 'play';
        } else {
          player.play();
          return play_button.icon = 'pause';
        }
      } else if (id) {
        return music_library.get(id, function(data) {
          return music_storage.get(data.name).onsuccess = function() {
            var update_cover,
              _this = this;
            if (player != null) {
              player.stop();
            }
            if (file_to_play) {
              URL.revokeObjectURL(file_to_play);
            }
            file_to_play = URL.createObjectURL(this.result);
            player = AV.Player.fromURL(file_to_play);
            update_cover = function(cover) {
              var cover_bg;
              element.shadowRoot.querySelector('cs-cover').style.backgroundImage = cover ? "url(" + cover + ")" : 'none';
              cover_bg = cover || '/web-components/cs-music-player/img/bg.jpg';
              element.style.backgroundImage = "url(" + cover_bg;
              if (cover) {
                new Blur({
                  el: element,
                  path: cover,
                  radius: 10
                });
              }
              return setTimeout((function() {
                return URL.revokeObjectURL(cover);
              }), 500);
            };
            if (data.name.substr(-4) === '.mp3') {
              parseAudioMetadata(this.result, function(metadata) {
                var cover;
                cover = metadata.picture;
                if (cover) {
                  cover = URL.createObjectURL(cover);
                }
                return update_cover(cover);
              }, {
                tags: ['picture']
              });
            }
            player.on('ready', function() {
              this.device.device.node.context.mozAudioChannelType = 'content';
              if (data.name.substr(-4) !== '.mp3') {
                return setTimeout((function() {
                  var _ref;
                  return update_cover((_ref = player.asset.metadata.coverArt) != null ? _ref.toBlobURL() : void 0);
                }), 0);
              }
            });
            player.on('end', function() {
              return element.next();
            });
            player.play();
            play_button.icon = 'pause';
            return music_library.get_meta(id, function(data) {
              if (data) {
                element.title = data.title || 'Unknown';
                element.artist = data.artist || 'Unknown';
                if (data.album) {
                  return element.artist += ": " + data.album;
                }
              } else {
                element.title = 'Unknown';
                return element.artist = 'Unknown';
              }
            });
          };
        });
      } else {
        return music_playlist.current(function(id) {
          return _this.play(id);
        });
      }
    },
    prev: function() {
      var _this = this;
      return music_playlist.prev(function(id) {
        return _this.play(id);
      });
    },
    next: function() {
      var _this = this;
      return music_playlist.next(function(id) {
        return _this.play(id);
      });
    }
  });

}).call(this);
